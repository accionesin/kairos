<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üîç Acciones.in ‚Äì Detecci√≥n de in-prendedores</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; }
    img { max-width: 100%; margin-top: 10px; }
    .box { border: 1px solid #ddd; padding: 15px; margin-top: 15px; }
    .ok { color: green; }
    .error { color: red; }
  </style>
</head>
<body>

<h2>üîç Acciones.in ‚Äì Detecci√≥n de in-prendedores</h2>

<input type="file" id="imageFile" />
<br><br>
<button onclick="detect()">Detectar rostro</button>

<div id="result" class="box"></div>

<div id="enrollBox" class="box" style="display:none;">
  <h3>üñº Este es el rostro que vamos a registrar</h3>
  <img id="preview" />
  <br><br>
  <input id="nombre" placeholder="Nombre" />
  <input id="apellido" placeholder="Apellido" />
  <br><br>
  <button onclick="enroll()">Registrar este rostro</button>
</div>

<script>
let imageBase64 = null;
let confidence = 0;

async function detect() {
  const file = document.getElementById("imageFile").files[0];
  if (!file) return alert("Adjunta una imagen");

  imageBase64 = await toBase64(file);
  document.getElementById("preview").src = imageBase64;

  const res = await fetch("https://kairos.clubempx.workers.dev/detect", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ image: imageBase64 })
  });

  const data = await res.json();
  const face = data.images?.[0]?.faces?.[0];

  if (!face) {
    result.innerHTML = "<p class='error'>‚ùå No se detect√≥ un rostro v√°lido</p>";
    return;
  }

  confidence = face.confidence * 100;

  result.innerHTML = `
    <p class="ok">‚úÖ Rostro detectado correctamente</p>
    Edad estimada: ${face.attributes.age} a√±os<br>
    G√©nero: ${face.attributes.gender.type === "M" ? "Masculino" : "Femenino"}<br>
    Confianza: ${confidence.toFixed(2)} %
  `;

  if (confidence >= 80) {
    enrollBox.style.display = "block";
  }
}

async function enroll() {
  const nombre = document.getElementById("nombre").value.trim();
  const apellido = document.getElementById("apellido").value.trim();

  if (!nombre || !apellido) {
    return alert("Nombre y apellido requeridos");
  }

  const subject_id = `${nombre}${apellido}_${Date.now()}`;

  const res = await fetch("https://kairos.clubempx.workers.dev/enroll", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      image: imageBase64,
      subject_id
    })
  });

  const data = await res.json();

  if (data.Errors) {
    result.innerHTML = `<p class="error">‚ùå Error al registrar</p>`;
    return;
  }

  result.innerHTML = `
    <p class="ok">‚úÖ Rostro registrado correctamente</p>
    Nombre: ${nombre} ${apellido}<br>
    ID asignado: ${subject_id}<br>
    Galer√≠a: acciones.in<br>
    El sistema podr√° reconocer este rostro en el futuro
  `;
}

function toBase64(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}
</script>

</body>
</html>
